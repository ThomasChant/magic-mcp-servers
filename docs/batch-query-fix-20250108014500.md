# Batch Query Fix - Preventing Individual Score Queries

## Issue
Despite implementing batch score queries, individual API calls were still being made because:
1. Components couldn't distinguish between "batch query in progress" vs "no batch provider"
2. DetailedVoteButtons component wasn't using the batch optimization
3. Some VoteButtons instances weren't wrapped in BatchScoreProvider

## Root Cause Analysis
The original `useBatchScore` hook only returned the score or `undefined`, making it impossible for components to know whether:
- A batch query was in progress (should wait)
- No batch provider existed (should make individual query)

## Solution

### 1. Enhanced useBatchScore Hook
Modified to return an object with:
```typescript
{
    score: ServerScore | undefined;
    isLoading: boolean;
    hasBatchProvider: boolean;
}
```

### 2. Fixed VoteButtons Logic
Updated to only make individual queries when no batch provider exists:
```typescript
const { score: batchScore, isLoading: batchLoading, hasBatchProvider } = useBatchScore(serverId);
const shouldFetchIndividual = !hasBatchProvider;
const { data: individualScore, isLoading: individualScoreLoading } = useServerScore(serverId, shouldFetchIndividual);
```

### 3. Fixed DetailedVoteButtons
Updated DetailedVoteButtons component to use the same batch optimization pattern as the main VoteButtons component.

### 4. Added BatchScoreProvider to ServerDetail
Wrapped the VoteButtons in ServerDetail page with BatchScoreProvider for consistency.

## Files Modified
- `src/components/BatchScoreProvider.tsx` - Enhanced hook interface
- `src/components/VoteButtons.tsx` - Fixed logic and DetailedVoteButtons
- `src/pages/ServerDetail.tsx` - Added BatchScoreProvider wrapper
- `src/services/voting.ts` - Added enabled parameter to useServerScore

## Expected Result
Now when components are wrapped in BatchScoreProvider:
- Only one batch query is made per page
- No individual queries are triggered during batch loading
- Components wait for batch query completion before falling back

When components are NOT wrapped in BatchScoreProvider:
- Individual queries work as before (backward compatibility)

## Testing
After these changes, you should see:
- Only 1 `server_scores?select=*&server_id=in.(...)` query per page
- No individual `server_scores?select=*&server_id=eq.xxx` queries on pages with BatchScoreProvider