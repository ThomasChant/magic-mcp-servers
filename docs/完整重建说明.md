# 数据库完整重建说明

## 问题现状
所有视图查询都报错：`column reference "github_url" is ambiguous`

## 解决方案
完整删除并重建所有视图和函数，彻底解决列冲突问题。

## 使用步骤

### 1. 执行重建脚本
1. 打开 Supabase SQL Editor
2. 复制 `COMPLETE_REBUILD.sql` 的完整内容
3. 粘贴并执行

### 2. 验证修复结果
```bash
npm run db:test-rebuild
```

## 重建内容

### 删除的内容
- ❌ 所有现有视图（servers_with_details, server_scores等）
- ❌ 所有投票相关函数
- ❌ 所有有冲突的函数

### 重建的内容
- ✅ 修复参数冲突的函数（is_monorepo, get_monorepo_mcp_count等）
- ✅ 无列冲突的 servers_with_details 视图
- ✅ 所有依赖视图（featured_servers, popular_servers等）
- ✅ 完整的投票系统功能
- ✅ 防刷票机制

## 修复的问题

1. **函数参数冲突**：`get_monorepo_mcp_count(github_url)` → `get_monorepo_mcp_count(input_github_url)`
2. **列名冲突**：明确指定表名和列名
3. **视图依赖**：正确的删除和重建顺序
4. **投票系统**：完整的Reddit风格投票功能

## 预期结果

执行后将解决：
- ✅ `column reference "github_url" is ambiguous` 错误
- ✅ `column "total_score" does not exist` 错误
- ✅ 所有视图查询正常工作
- ✅ 应用程序正常加载
- ✅ 投票功能完全可用

## 验证命令

```bash
# 测试完整重建
npm run db:test-rebuild

# 如果需要调试
npm run db:debug
```

## 回滚方案

如果重建失败，可以使用基础视图：

```sql
-- 紧急回滚：创建基础视图
CREATE VIEW servers_with_details AS
SELECT s.*, 0 as total_score, 0 as upvotes, 0 as downvotes
FROM mcp_servers s;
```

这是一个**彻底的解决方案**，将完全消除所有列冲突和函数冲突问题。